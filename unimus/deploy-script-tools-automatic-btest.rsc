/system script remove tools-automatic-btest;
/system script add name="tools-automatic-btest" policy=read,test comment="Tools/Automatic-BTest Test Runner" source="{\n	:local formatDateTime [:parse [/system script get func_formatDateTime source]];\n	:local routeID [/ip route find dst-address=0.0.0.0/0]\n    # BTest Server Settings\n	:local btestServer { username=\"btest\" ; password=\"Ek4@C;f%(-(P3+~5\" ; hostname=[/ip route get \$routeID value-name=gateway] }\n    # TCP Test Settings\n	:local tcpOptions { duration=\"2s\" ; \"updateInterval\"=\"1s\" }\n    # UDP Test Settings\n	:local udpOptions { duration=\"2s\" ; \"updateInterval\"=\"1s\" ; \"rxSize\"=1000 ; \"txSize\"=1000 }\n    # Test Results\n	:local tcpRxTest { start=\"\" ; updated=\"\" ; end=\"\" ; peak=0 ; current=0 ; average=0 };\n	:local tcpTxTest { start=\"\" ; updated=\"\" ; end=\"\" ; peak=0 ; current=0 ; average=0 };\n	:local udpRxTest { start=\"\" ; updated=\"\" ; end=\"\" ; peak=0 ; current=0 ; average=0 ; size=0 ;  \"lostPackets\"=0 };\n	:local udpTxTest { start=\"\" ; updated=\"\" ; end=\"\" ; peak=0 ; current=0 ; average=0 ; size=0 }\n    # TCP Downstream Test\n	:set (\$tcpRxTest->\"start\") [\$formatDateTime];\n	\n	/tool bandwidth-test (\$btestServer->\"hostname\") protocol=tcp random-data=no direction=receive duration=(\$tcpOptions->\"duration\") user=(\$btestServer->\"username\") password=(\$btestServer->\"password\") do={\n		:set (\$tcpRxTest->\"updated\") [\$formatDateTime];\n		:set (\$tcpRxTest->\"current\") (\$\"rx-current\" / 1000000);\n		:set (\$tcpRxTest->\"average\") (\$\"rx-total-average\" / 1000000);\n		:if ( (\$tcpRxTest->\"peak\") < (\$tcpRxTest->\"current\") ) do={\n			:set (\$tcpRxTest->\"peak\") (\$tcpRxTest->\"current\");\n		};\n	};\n	\n	:set (\$tcpRxTest->\"end\") [\$formatDateTime]\n    # Log Test Results\n	:log info (\"Tools/Automatic-BTest: TCP Downstream; Started: \" . (\$tcpRxTest->\"start\") . \"; Completed: \" . (\$tcpRxTest->\"end\") . \"; Server: \" . (\$btestServer->\"hostname\") . \"; Peak: \" . (\$tcpRxTest->\"peak\") . \" Mbps; Average: \" . (\$tcpRxTest->\"average\") . \" Mbps; Duration: \" . (\$tcpOptions->\"duration\") . \";\");\n	\n	# TCP Upstream Test\n	:set (\$tcpTxTest->\"start\") [\$formatDateTime];\n	\n	/tool bandwidth-test (\$btestServer->\"hostname\") protocol=tcp random-data=no direction=transmit duration=(\$tcpOptions->\"duration\") user=(\$btestServer->\"username\") password=(\$btestServer->\"password\") do={\n		:set (\$tcpTxTest->\"updated\") [\$formatDateTime];\n		:set (\$tcpTxTest->\"current\") (\$\"tx-current\" / 1000000);\n		:set (\$tcpTxTest->\"average\") (\$\"tx-total-average\" / 1000000);\n		:if ( (\$tcpTxTest->\"peak\") < (\$tcpTxTest->\"current\") ) do={\n			:set (\$tcpTxTest->\"peak\") (\$tcpTxTest->\"current\");\n		};\n	};\n	:set (\$tcpTxTest->\"end\") [\$formatDateTime];\n	\n	# Log Test Results\n	:log info (\"Tools/Automatic-BTest: TCP Upstream; Started: \" . (\$tcpTxTest->\"start\") . \"; Completed: \" . (\$tcpTxTest->\"end\") . \"; Server: \" . (\$btestServer->\"hostname\") . \"; Peak: \" . (\$tcpTxTest->\"peak\") . \" Mbps; Average: \" . (\$tcpTxTest->\"average\") . \" Mbps; Duration: \" . (\$tcpOptions->\"duration\") . \";\");\n	\n	# UDP Downstream Test\n	:set (\$udpRxTest->\"start\") [\$formatDateTime];\n	\n	/tool bandwidth-test (\$btestServer->\"hostname\") protocol=udp random-data=no direction=receive duration=(\$udpOptions->\"duration\") user=(\$btestServer->\"username\") password=(\$btestServer->\"password\") remote-udp-tx-size=(\$udpOptions->\"rxSize\") do={\n		:set (\$udpRxTest->\"updated\") [\$formatDateTime];\n		:set (\$udpRxTest->\"current\") (\$\"rx-current\" / 1000000);\n		:set (\$udpRxTest->\"average\") (\$\"rx-total-average\" / 1000000);\n		:set (\$udpRxTest->\"lostPackets\") (\$\"lost-packets\" / 1);\n		:set (\$udpRxTest->\"size\") (\$\"rx-size\" / 1);\n		:if ( (\$udpRxTest->\"peak\") < (\$udpRxTest->\"current\") ) do={\n			:set (\$udpRxTest->\"peak\") (\$udpRxTest->\"current\");\n		};\n	};\n	:set (\$udpRxTest->\"end\") [\$formatDateTime];\n	\n	# Log Test Results\n	:log info (\"Tools/Automatic-BTest: UDP Downstream; Started: \" . (\$udpRxTest->\"start\") . \"; Completed: \" . (\$udpRxTest->\"end\") . \"; Server: \" . (\$btestServer->\"hostname\") . \"; Peak: \" . (\$udpRxTest->\"peak\") . \" Mbps; Average: \" . (\$udpRxTest->\"average\") . \" Mbps; Packet Size: \" . (\$udpRxTest->\"size\") . \"; Duration: \" . (\$udpOptions->\"duration\") . \"; Lost Packets: \" . (\$udpRxTest->\"lostPackets\") . \";\");\n	\n	# UDP Upstream Test\n	:set (\$udpTxTest->\"start\") [\$formatDateTime];\n	\n	/tool bandwidth-test (\$btestServer->\"hostname\") protocol=udp random-data=no direction=transmit duration=(\$udpOptions->\"duration\") user=(\$btestServer->\"username\") password=(\$btestServer->\"password\") local-udp-tx-size=(\$udpOptions->\"txSize\") do={\n		:set (\$udpTxTest->\"updated\") [\$formatDateTime];\n		:set (\$udpTxTest->\"current\") (\$\"tx-current\" / 1000000);\n		:set (\$udpTxTest->\"average\") (\$\"tx-total-average\" / 1000000);\n		:set (\$udpTxTest->\"size\") (\$\"tx-size\" / 1);\n		:if ( (\$udpTxTest->\"peak\") < (\$udpTxTest->\"current\") ) do={\n			:set (\$udpTxTest->\"peak\") (\$udpTxTest->\"current\");\n		};\n	};\n	:set (\$udpTxTest->\"end\") [\$formatDateTime];\n	\n	# Log Test Results\n	:log info (\"Tools/Automatic-BTest: UDP Upstream; Started: \" . (\$udpTxTest->\"start\") . \"; Completed: \" . (\$udpTxTest->\"end\") . \"; Server: \" . (\$btestServer->\"hostname\") . \"; Peak: \" . (\$udpTxTest->\"peak\") . \" Mbps; Average: \" . (\$udpTxTest->\"average\") . \" Mbps; Packet Size: \" . (\$udpTxTest->\"size\") . \"; Duration: \" . (\$udpOptions->\"duration\") . \";\");\n};\n"
